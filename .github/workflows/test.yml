name: Crypto CI/CD

on:
  push:
    tags: ['v*.*.*']  # Trigger on version tags (e.g., v1.0.0)
  pull_request:
    branches: [master]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      VERSION: ${GITHUB_REF#refs/tags/v}  # Extracts version from tag (v1.0.0 â†’ 1.0.0)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang

    - name: Build
      run: |
        make clean
        make

    - name: Run tests
      run: |
        cd tests && make clean && make && make test

    - name: Package artifacts
      run: |
        mkdir -p dist/{lib,include}

        # Library files
        cp build/libcrypto.so.$VERSION dist/lib/
        cp build/libcrypto.a dist/lib/

        # Headers (preserve structure)
        cp -r include/* dist/include/

        # Create simple pkg-config file
        cat > dist/libcrypto.pc <<EOF
        prefix=/usr/local
        libdir=\${prefix}/lib
        includedir=\${prefix}/include

        Name: libcrypto
        Description: Educational crypto library
        Version: $VERSION
        Libs: -L\${libdir} -lcrypto
        Cflags: -I\${includedir}
        EOF

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libcrypto-${{ env.VERSION }}-linux
        path: dist/
        retention-days: 1

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        files: |
          dist/lib/*
          dist/include/*
          dist/libcrypto.pc
